# FHIR Security Alert Rules
# Author: Nithin Mohan T K
# Repository: https://github.com/nithinmohantk/fhir-security
#
# These rules define critical security alerts for FHIR API monitoring.
# Integrate with PagerDuty, Slack, or email via Alertmanager.

groups:
  - name: fhir_security_critical
    rules:
      # Authentication Failures
      - alert: HighAuthenticationFailureRate
        expr: sum(rate(fhir_auth_failures_total[5m])) > 10
        for: 2m
        labels:
          severity: critical
          category: authentication
        annotations:
          summary: "High authentication failure rate detected"
          description: 'More than 10 authentication failures per second over the last 5 minutes. Current rate: {{ $value | printf "%.2f" }}/s'
          runbook_url: "https://wiki.example.com/runbooks/fhir-auth-failures"

      - alert: TokenReplayAttackDetected
        expr: sum(rate(dpop_replay_attempts_total[5m])) > 0
        for: 1m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "⚠️ POTENTIAL ATTACK: DPoP token replay detected"
          description: 'Possible token replay attack in progress. {{ $value | printf "%.0f" }} replay attempts detected in the last 5 minutes.'
          runbook_url: "https://wiki.example.com/runbooks/token-replay"

      - alert: BulkExportAbuse
        expr: sum(rate(fhir_bulk_export_requests_total[10m])) by (client_id) > 5
        for: 5m
        labels:
          severity: critical
          category: data_exfiltration
        annotations:
          summary: "⚠️ Unusual bulk export activity from {{ $labels.client_id }}"
          description: 'Client {{ $labels.client_id }} has initiated {{ $value | printf "%.0f" }} bulk export requests in 10 minutes. This may indicate data exfiltration.'
          runbook_url: "https://wiki.example.com/runbooks/bulk-export-abuse"

      - alert: UnauthorizedCrossPatientAccess
        expr: sum(rate(fhir_cross_patient_access_denied_total[5m])) > 5
        for: 2m
        labels:
          severity: critical
          category: authorization
        annotations:
          summary: "Cross-patient access attempts detected"
          description: '{{ $value | printf "%.0f" }} unauthorized cross-patient access attempts in 5 minutes. Possible horizontal privilege escalation.'
          runbook_url: "https://wiki.example.com/runbooks/cross-patient-access"

  - name: fhir_security_warning
    rules:
      - alert: ElevatedScopeViolations
        expr: sum(rate(fhir_auth_failures_total{reason="scope_violation"}[5m])) > 5
        for: 5m
        labels:
          severity: warning
          category: authorization
        annotations:
          summary: "Elevated scope violation rate"
          description: '{{ $value | printf "%.0f" }} scope violations per second. Clients may be requesting unauthorized resources.'

      - alert: ExpiredTokenUsage
        expr: sum(rate(fhir_auth_failures_total{reason="expired_token"}[5m])) > 10
        for: 5m
        labels:
          severity: warning
          category: authentication
        annotations:
          summary: "High rate of expired token usage"
          description: '{{ $value | printf "%.0f" }} expired token attempts per second. Check client token refresh logic.'

      - alert: UnusualIPActivity
        expr: count(count by (source_ip) (increase(fhir_api_requests_total{source_ip!~"10\\..*|192\\.168\\..*"}[1h]) > 1000)) > 5
        for: 10m
        labels:
          severity: warning
          category: anomaly
        annotations:
          summary: "Unusual IP activity detected"
          description: "Multiple external IPs with >1000 requests in the last hour. Review for potential scanning or attack."

      - alert: DPoPValidationFailures
        expr: sum(rate(dpop_validation_failures_total[5m])) > 5
        for: 3m
        labels:
          severity: warning
          category: authentication
        annotations:
          summary: "DPoP proof validation failures"
          description: '{{ $value | printf "%.0f" }} DPoP validation failures per second. Check client implementations or clock sync.'

  - name: fhir_availability
    rules:
      - alert: FHIRServerDown
        expr: up{job="fhir-server"} == 0
        for: 1m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "FHIR Server is down"
          description: "The FHIR server {{ $labels.instance }} has been unreachable for more than 1 minute."

      - alert: IdentityServerDown
        expr: up{job="identity-server"} == 0
        for: 1m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "Identity Server is down"
          description: "The OAuth/Identity server {{ $labels.instance }} is unreachable. All authentication will fail."

      - alert: HighAPILatency
        expr: histogram_quantile(0.95, sum(rate(fhir_api_request_duration_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High API latency detected"
          description: '95th percentile latency is {{ $value | printf "%.2f" }}s. Target is <500ms.'

      - alert: HighErrorRate
        expr: sum(rate(fhir_api_requests_total{status=~"5.."}[5m])) / sum(rate(fhir_api_requests_total[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "High error rate detected"
          description: 'Error rate is {{ $value | printf "%.1f" }}%. Target is <1%.'

  - name: fhir_compliance
    rules:
      - alert: AuditLogGap
        expr: time() - fhir_last_audit_log_timestamp > 300
        for: 5m
        labels:
          severity: critical
          category: compliance
        annotations:
          summary: "⚠️ HIPAA RISK: Audit log gap detected"
          description: 'No audit log entries for {{ $value | printf "%.0f" }} seconds. HIPAA requires continuous audit logging.'
          runbook_url: "https://wiki.example.com/runbooks/audit-log-gap"

      - alert: UnencryptedConnection
        expr: sum(fhir_api_requests_total{tls_version=""}) > 0
        for: 1m
        labels:
          severity: critical
          category: compliance
        annotations:
          summary: "⚠️ HIPAA VIOLATION: Unencrypted connections detected"
          description: '{{ $value | printf "%.0f" }} requests received over unencrypted connections. This violates HIPAA §164.312(e)(1).'

      - alert: WeakTLSVersion
        expr: sum(fhir_api_requests_total{tls_version=~"TLSv1|TLSv1.1"}) > 0
        for: 1m
        labels:
          severity: critical
          category: compliance
        annotations:
          summary: "⚠️ SECURITY RISK: Weak TLS version in use"
          description: "Connections using deprecated TLS 1.0/1.1 detected. Upgrade clients immediately."

  - name: kafka_pipeline
    rules:
      - alert: KafkaConsumerLag
        expr: kafka_consumer_group_lag > 10000
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Kafka consumer lag is high"
          description: 'Consumer group {{ $labels.group }} has {{ $value | printf "%.0f" }} messages lag. Real-time alerts may be delayed.'

      - alert: KafkaConsumerLagCritical
        expr: kafka_consumer_group_lag > 100000
        for: 2m
        labels:
          severity: critical
          category: performance
        annotations:
          summary: "⚠️ CRITICAL: Kafka consumer lag is very high"
          description: 'Consumer group {{ $labels.group }} has {{ $value | printf "%.0f" }} messages lag. Clinical alerts are severely delayed!'
          runbook_url: "https://wiki.example.com/runbooks/kafka-lag"

      - alert: KafkaBrokerDown
        expr: kafka_broker_up == 0
        for: 1m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "Kafka broker is down"
          description: "Kafka broker {{ $labels.instance }} is unreachable. Event pipeline may be impaired."
